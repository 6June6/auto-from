# 用户闪退排查手册 🔍

> 当用户报告"登录后就闪退"时的标准排查流程

## 🚨 紧急排查流程(5分钟)

### 第1步: 获取基本信息

向用户询问:

- [ ] 用户名是什么?
- [ ] 大概什么时间闪退的?
- [ ] 是每次登录都闪退,还是偶尔?

### 第2步: 快速查看错误日志

```bash
# 方法1: 使用日志查看器(推荐)
./view_logs.sh
# 然后在搜索框输入用户名

# 方法2: 命令行快速查看
grep "用户名" ~/.auto-form-filler/logs/error.log | tail -20
```

### 第3步: 查看崩溃日志

```bash
# 查看最近的崩溃记录
tail -100 ~/.auto-form-filler/logs/crash.log | grep -A 50 "用户名"
```

### 第4步: 分析崩溃原因

查看错误信息中的:

- ✅ 异常类型(AttributeError, KeyError, etc.)
- ✅ 异常信息(具体的错误描述)
- ✅ 堆栈跟踪(定位出错的代码行)

## 📋 详细排查流程

### 步骤1: 启动日志查看器

```bash
./view_logs.sh
```

**操作:**

1. 点击左侧文件列表选择 `error.log`
2. 在搜索框输入用户名
3. 查看"仅错误"标签页

### 步骤2: 定位闪退时间点

查找日志中的关键标记:

```
✅ 用户登录成功          ← 登录成功
📝 启动表单填写界面...    ← 开始创建主窗口
❌ 创建主窗口失败         ← 崩溃点!
```

**示例日志:**

```
2026-02-09 14:30:10 | INFO | [User: test_user] ✅ 用户登录成功
2026-02-09 14:30:11 | INFO | [User: test_user] 📝 启动表单填写界面...
2026-02-09 14:30:12 | ERROR | [User: test_user] 创建主窗口失败: 'NoneType' object has no attribute 'show'
```

### 步骤3: 查看完整的堆栈跟踪

切换到"崩溃详情"标签页,查看:

```
堆栈跟踪:
  File "/path/to/main.py", line 142, in create_main_window
    main_window.show()
  AttributeError: 'NoneType' object has no attribute 'show'
```

**这告诉我们:**

- 出错文件: `main.py`
- 出错行号: `142`
- 出错函数: `create_main_window`
- 错误原因: `main_window` 是 None

### 步骤4: 查看用户完整操作流程

```bash
# 查看该用户的所有日志
grep "test_user" ~/.auto-form-filler/logs/app.log | tail -50
```

**分析:**

- 登录前做了什么?
- 登录后第一个操作是什么?
- 哪个步骤开始出错?

### 步骤5: 对比正常用户

```bash
# 查看一个正常用户的日志
grep "normal_user" ~/.auto-form-filler/logs/app.log | tail -20
```

**对比:**

- 正常用户和问题用户的日志有什么区别?
- 是否缺少某些步骤?
- 是否有额外的错误?

## 🎯 常见闪退原因及解决方案

### 1. 主窗口创建失败

**症状:**

```
AttributeError: 'NoneType' object has no attribute 'show'
```

**原因:**

- 窗口初始化时出错
- 返回了 None
- 没有正确创建窗口对象

**排查:**

```python
# 检查 main.py 中的 create_main_window 函数
# 确保 AdminMainWindow 或 MainWindow 正常返回
```

**解决:**

- 在窗口构造函数中添加异常捕获
- 检查窗口依赖的资源是否存在
- 验证数据库连接是否正常

### 2. 数据加载失败

**症状:**

```
KeyError: 'user_config'
AttributeError: 'User' object has no attribute 'config'
```

**原因:**

- 用户数据不完整
- 数据库中缺少必要字段
- 配置文件损坏

**排查:**

```python
# 检查用户数据结构
# 验证数据库中该用户的记录是否完整
```

**解决:**

- 为缺失的字段设置默认值
- 修复用户数据
- 重置用户配置

### 3. 资源文件缺失

**症状:**

```
FileNotFoundError: [Errno 2] No such file or directory: 'xxx.png'
```

**原因:**

- 图标文件缺失
- 配置文件路径错误
- 相对路径问题

**排查:**

```bash
# 检查资源文件是否存在
ls -la gui/icons/
ls -la config/
```

**解决:**

- 确保资源文件存在
- 使用绝对路径或正确的相对路径
- 添加文件存在性检查

### 4. Qt 动画异常

**症状:**

```
Qt Critical: animation object already deleted
```

**原因:**

- 窗口关闭时动画对象未清理
- 动画对象被提前释放
- 内存管理问题

**排查:**

```python
# 检查 login_window.py 中的动画清理代码
# 查看 _cleanup_animations 函数
```

**解决:**

- 在窗口关闭前停止所有动画
- 添加动画对象的引用计数
- 使用 try-except 保护清理代码

### 5. 数据库连接异常

**症状:**

```
pymongo.errors.ServerSelectionTimeoutError: No servers found
```

**原因:**

- 网络连接问题
- 数据库服务器宕机
- 连接字符串错误

**排查:**

```bash
# 测试数据库连接
python3 test_mongodb_connection.py
```

**解决:**

- 检查网络连接
- 验证数据库服务状态
- 更新连接字符串

### 6. 权限问题

**症状:**

```
PermissionError: [Errno 13] Permission denied
```

**原因:**

- 文件/目录没有读写权限
- 配置文件被锁定
- 日志目录无法写入

**排查:**

```bash
# 检查目录权限
ls -ld ~/.auto-form-filler/
ls -ld ~/.auto-form-filler/logs/
```

**解决:**

```bash
# 修复权限
chmod 755 ~/.auto-form-filler/
chmod 644 ~/.auto-form-filler/.token
```

## 🔬 深度分析工具

### 1. 查看崩溃详情 JSON

```bash
# 查看最新的崩溃详情
ls -t ~/.auto-form-filler/logs/crash_*.json | head -1 | xargs cat | python3 -m json.tool
```

**包含信息:**

- 精确的时间戳
- 完整的用户信息
- 系统环境信息
- 详细的堆栈跟踪

### 2. 提取特定时间段的日志

```bash
# 提取某天的所有错误
grep "2026-02-09" ~/.auto-form-filler/logs/error.log | grep "test_user"

# 提取某个时间段
awk '/2026-02-09 14:30/,/2026-02-09 14:35/' ~/.auto-form-filler/logs/app.log | grep "test_user"
```

### 3. 统计错误类型

```bash
# 统计最常见的错误
grep "ERROR" ~/.auto-form-filler/logs/error.log | \
  sed 's/.*\(Error\|Exception\).*/\1/' | \
  sort | uniq -c | sort -rn
```

### 4. 导出用户日志

```bash
# 导出特定用户的所有日志
grep "test_user" ~/.auto-form-filler/logs/*.log > user_test_user_$(date +%Y%m%d).log
```

## 📱 实时监控模式

### 请用户重现问题时使用

**终端1: 实时监控错误日志**

```bash
tail -f ~/.auto-form-filler/logs/error.log | grep --color=always "ERROR\|CRITICAL"
```

**终端2: 实时监控应用日志**

```bash
tail -f ~/.auto-form-filler/logs/app.log | grep "用户名"
```

**终端3: 运行应用**

```bash
python3 main.py
```

这样可以实时看到用户操作和错误的对应关系。

## 📊 排查决策树

```
用户报告闪退
    ↓
查看error.log中该用户的最后几条日志
    ↓
  是否有ERROR/CRITICAL?
    ├─ 是 → 查看错误类型和堆栈跟踪 → 定位代码 → 修复
    └─ 否 → 查看crash.log
          ↓
        是否有崩溃记录?
          ├─ 是 → 查看crash_*.json详情 → 分析系统环境 → 修复
          └─ 否 → 对比正常用户日志 → 找出差异 → 调查
```

## 🎓 案例分析

### 案例1: AttributeError 闪退

**症状:**
用户 "test_user" 登录后闪退

**日志:**

```
2026-02-09 14:30:10 | INFO | [User: test_user] ✅ 用户登录成功
2026-02-09 14:30:11 | INFO | [User: test_user] 📝 启动表单填写界面...
2026-02-09 14:30:12 | ERROR | [User: test_user] 创建主窗口失败: 'NoneType'
```

**分析:**
主窗口创建返回了 None

**排查:**

1. 检查 `MainWindow.__init__` 是否有异常
2. 查看该用户的数据是否完整
3. 验证依赖的资源是否存在

**修复:**
在 `main.py` 的 `create_main_window` 中添加更详细的错误处理

### 案例2: 数据库查询失败

**症状:**
特定用户登录后崩溃

**日志:**

```
2026-02-09 14:30:10 | INFO | [User: special_user] ✅ 用户登录成功
2026-02-09 14:30:11 | ERROR | 数据库查询异常: No document found
```

**分析:**
该用户的关联数据缺失

**排查:**

1. 查询数据库中该用户的完整数据
2. 检查关联表是否有记录
3. 验证数据完整性约束

**修复:**

- 修复用户数据
- 添加数据验证
- 设置默认值

## ✅ 排查完成检查清单

完成排查后,确保:

- [ ] 找到了具体的错误原因
- [ ] 定位了出错的代码行
- [ ] 理解了为什么会出错
- [ ] 知道如何修复
- [ ] 验证了修复方案
- [ ] 测试了修复后的代码
- [ ] 文档记录了问题和解决方案

## 🚀 预防措施

### 1. 定期检查日志

```bash
# 每天检查崩溃日志
tail -20 ~/.auto-form-filler/logs/crash.log

# 每周统计错误
grep "ERROR" ~/.auto-form-filler/logs/error.log | wc -l
```

### 2. 监控异常用户

```bash
# 查找频繁出错的用户
grep "ERROR" ~/.auto-form-filler/logs/error.log | \
  grep -oP '\[User: \K[^\]]+' | \
  sort | uniq -c | sort -rn | head -10
```

### 3. 数据完整性检查

定期验证:

- 用户数据完整性
- 配置文件有效性
- 资源文件存在性

### 4. 添加更多日志

在关键位置添加日志:

```python
logger.log_debug(f"窗口初始化开始: {user.username}")
logger.log_debug(f"加载用户配置: {config}")
logger.log_debug(f"创建UI组件完成")
```

## 📞 获取帮助

如果无法解决问题:

1. 导出完整日志:

```bash
tar -czf logs_$(date +%Y%m%d).tar.gz ~/.auto-form-filler/logs/
```

2. 记录:
   - 用户名
   - 闪退时间
   - 用户操作步骤
   - 系统环境信息

3. 查看相关文档:
   - `日志监控使用指南.md`
   - `日志监控系统部署总结.md`

## 💡 专业提示

1. **始终从用户角度分析**
   - 用户做了什么?
   - 期望得到什么?
   - 实际发生了什么?

2. **不要忽略警告日志**
   - WARNING 可能是 ERROR 的前兆
   - 多个警告可能累积成崩溃

3. **对比分析很重要**
   - 正常用户 vs 问题用户
   - 成功登录 vs 失败登录
   - 不同时间段的日志

4. **保持日志清洁**
   - 定期清理旧日志
   - 只记录有用的信息
   - 避免日志过载

---

📝 **记住:** 好的日志是解决问题的一半! 🎉
