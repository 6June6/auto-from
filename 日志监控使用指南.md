# 日志监控使用指南

## 📋 概述

本系统已集成完整的日志监控功能，可以捕获和记录所有异常、错误和崩溃信息，特别是针对单个用户的闪退问题。

## 🎯 核心功能

### 1. 三级日志系统

| 日志类型     | 文件名                       | 说明                     | 大小限制            |
| ------------ | ---------------------------- | ------------------------ | ------------------- |
| **崩溃日志** | `crash.log`                  | 记录严重错误和程序崩溃   | 10MB (保留5个备份)  |
| **错误日志** | `error.log`                  | 记录所有异常和错误       | 20MB (保留10个备份) |
| **应用日志** | `app.log`                    | 记录所有操作和调试信息   | 50MB (保留10个备份) |
| **崩溃详情** | `crash_YYYYMMDD_HHMMSS.json` | 独立的崩溃报告(JSON格式) | 每次崩溃一个文件    |

### 2. 日志存储位置

```
~/.auto-form-filler/logs/
├── crash.log          # 崩溃日志
├── error.log          # 错误日志
├── app.log            # 应用日志
├── crash_20260209_143022.json  # 崩溃详情
└── ...                # 旧日志备份
```

**实际路径示例:**

- macOS/Linux: `/Users/你的用户名/.auto-form-filler/logs/`
- Windows: `C:\Users\你的用户名\.auto-form-filler\logs\`

## 🔍 如何查看闪退日志

### 方法一：使用日志查看器(推荐)

1. **启动日志查看器:**

   ```bash
   ./view_logs.sh
   ```

   或者直接运行:

   ```bash
   python tools/log_viewer.py
   ```

2. **功能说明:**
   - ✅ 实时查看所有日志文件
   - ✅ 按类型筛选(应用/错误/崩溃)
   - ✅ 关键词搜索
   - ✅ 自动刷新(每5秒)
   - ✅ 高亮显示错误
   - ✅ 一键打开日志目录
   - ✅ 清理旧日志

### 方法二：直接查看日志文件

```bash
# 查看崩溃日志
tail -f ~/.auto-form-filler/logs/crash.log

# 查看错误日志
tail -f ~/.auto-form-filler/logs/error.log

# 查看应用日志
tail -f ~/.auto-form-filler/logs/app.log
```

### 方法三：查看崩溃详情 JSON

```bash
# 查看最新的崩溃详情
ls -lt ~/.auto-form-filler/logs/crash_*.json | head -1 | xargs cat | python -m json.tool
```

## 📊 日志内容说明

### 崩溃日志示例

```
2026-02-09 14:30:22 | CRITICAL |
================================================================================
🔴 程序崩溃
================================================================================
崩溃时间: 2026-02-09 14:30:22

用户信息:
  用户名: test_user
  用户ID: 507f1f77bcf86cd799439011
  设备ID: abc123def456
  角色: user

系统信息:
  操作系统: Darwin 25.2.0
  系统版本: Darwin Kernel Version 25.2.0
  Python版本: 3.11.5
  架构: arm64

异常类型: AttributeError
异常信息: 'NoneType' object has no attribute 'show'

堆栈跟踪:
  File "/path/to/main.py", line 142, in create_main_window
    main_window.show()
  AttributeError: 'NoneType' object has no attribute 'show'
================================================================================
```

### 错误日志示例

```
2026-02-09 14:25:10 | ERROR | [main_window.py:456] | [User: test_user] 加载配置失败: 文件不存在
2026-02-09 14:28:33 | ERROR | [database/db_manager.py:123] | [User: test_user] 数据库查询异常
```

### 应用日志示例

```
2026-02-09 14:20:05 | INFO     | 🚀 自动表单填写工具 v2.0.0 启动
2026-02-09 14:20:06 | INFO     | 🛡️ 全局异常钩子已设置
2026-02-09 14:20:07 | INFO     | [User: test_user] ✅ 用户登录成功
2026-02-09 14:20:08 | INFO     | [User: test_user] 📝 启动表单填写界面...
2026-02-09 14:20:09 | ERROR    | [User: test_user] 创建主窗口失败: 初始化异常
```

## 🔧 如何排查特定用户的闪退问题

### 1. 确定问题用户

在日志中搜索该用户的用户名:

```bash
grep "test_user" ~/.auto-form-filler/logs/error.log
```

### 2. 查看该用户的完整操作流程

```bash
# 查看该用户的所有日志
grep "test_user" ~/.auto-form-filler/logs/app.log | tail -50
```

### 3. 定位崩溃时间点

```bash
# 查看该用户的崩溃记录
grep -A 30 "test_user" ~/.auto-form-filler/logs/crash.log
```

### 4. 分析崩溃原因

查看崩溃详情 JSON 文件，包含:

- 完整的用户信息
- 系统环境信息
- 详细的堆栈跟踪
- 崩溃时间点

## 🛠️ 日志维护

### 自动日志轮转

系统会自动管理日志文件大小:

- 当日志文件超过限制时，自动创建备份
- 保留指定数量的备份文件
- 旧备份会自动删除

### 手动清理旧日志

使用日志查看器的"清理旧日志"功能，会删除 7 天前的所有日志文件。

或者手动删除:

```bash
# 删除 7 天前的日志
find ~/.auto-form-filler/logs/ -name "*.log*" -mtime +7 -delete
find ~/.auto-form-filler/logs/ -name "*.json" -mtime +7 -delete
```

## 📱 实时监控

### 方法一：使用日志查看器的自动刷新

1. 启动日志查看器
2. 选择要监控的日志文件
3. 点击"🔁 自动刷新: 关" 按钮开启自动刷新
4. 每 5 秒自动更新日志内容

### 方法二：使用 tail 命令

```bash
# 实时监控错误日志
tail -f ~/.auto-form-filler/logs/error.log

# 实时监控崩溃日志
tail -f ~/.auto-form-filler/logs/crash.log
```

## 🐛 调试建议

### 1. 复现问题

请用户提供:

- 用户名
- 闪退的大致时间
- 闪退前的操作步骤

### 2. 收集日志

```bash
# 打包该时间段的所有日志
cd ~/.auto-form-filler/logs/
tar -czf crash_logs_$(date +%Y%m%d).tar.gz *.log crash_*.json
```

### 3. 分析日志

重点关注:

- 用户登录成功后的第一个错误
- 主窗口创建相关的异常
- Qt 相关的警告和错误
- 数据库连接异常

### 4. 常见闪退原因

| 原因               | 日志特征             | 解决方案             |
| ------------------ | -------------------- | -------------------- |
| **主窗口创建失败** | `创建主窗口失败`     | 检查窗口初始化代码   |
| **数据库连接失败** | `数据库查询异常`     | 检查网络和数据库状态 |
| **Qt 资源不足**    | `Qt Critical/Fatal`  | 检查内存和 GPU 资源  |
| **动画对象异常**   | `animation` 相关错误 | 清理动画对象         |
| **配置文件损坏**   | `配置加载失败`       | 重置用户配置         |

## 📞 获取帮助

如果日志中出现无法理解的错误，可以:

1. 查看完整的堆栈跟踪
2. 搜索错误类型和错误信息
3. 检查是否有系统环境相关的错误
4. 对比正常用户和问题用户的日志差异

## 🔐 隐私说明

日志中会记录:

- ✅ 用户名和用户 ID
- ✅ 设备 ID
- ✅ 操作记录
- ✅ 错误信息

不会记录:

- ❌ 密码
- ❌ Token 完整内容
- ❌ 用户填写的表单数据
- ❌ 个人隐私信息

## 📚 相关文件

- `core/logger.py` - 日志管理模块
- `tools/log_viewer.py` - 日志查看器
- `view_logs.sh` - 启动脚本
- `main.py` - 已集成日志系统

## ✅ 验证日志系统

运行以下命令测试日志系统是否正常工作:

```bash
# 启动应用
python main.py

# 查看日志是否生成
ls -lh ~/.auto-form-filler/logs/

# 查看最新的应用日志
tail -20 ~/.auto-form-filler/logs/app.log
```

应该看到类似输出:

```
🚀 自动表单填写工具 v2.0.0 启动
🛡️ 全局异常钩子已设置
🔧 初始化 MongoDB 数据库...
```
