# 问卷星表单匹配修复说明

## 问题描述

用户反馈问卷星表单填充时，匹配成功率为 0，只检测到"我已阅读并同意问卷星"这一个同意条款字段，而实际的表单输入字段都没有被识别到。

### 问题原因

1. **`getAllInputs()` 函数过于简单**
   - 原实现只检查元素是否可见，没有过滤无效字段
   - 将"同意条款"的 checkbox 也当作有效输入框
   - 导致匹配逻辑将资源浪费在无关字段上

2. **`waitForInputs()` 函数等待逻辑不准确**
   - 只检查是否有 `input/textarea` 元素
   - 没有验证这些元素是否为**有效**的表单输入框
   - 可能在只加载出同意条款时就停止等待

## 修复方案

### 1. 优化 `getAllInputs()` 函数

**位置**：`gui/new_fill_window.py` - `generate_wjx_fill_script()` 方法内

**改进内容**：
- ✅ 过滤掉同意条款相关的 checkbox/radio（包含关键词：同意、阅读、隐私、协议、条款、服务、政策）
- ✅ 过滤掉隐藏元素（`display: none` 或 `visibility: hidden`）
- ✅ 过滤掉只读和禁用的输入框（`readOnly` 或 `disabled`）
- ✅ 过滤掉按钮类型的输入框（`submit`、`button`、`hidden`、`image`、`reset`）
- ✅ 增加日志输出，显示过滤后的有效输入框数量

**关键代码**：
```javascript
function getAllInputs() {
    const inputs = [];
    const excludeKeywords = ['同意', '阅读', '隐私', '协议', '条款', '服务', '政策'];
    
    document.querySelectorAll('input, textarea').forEach(input => {
        // 跳过隐藏元素
        const style = window.getComputedStyle(input);
        if (style.display === 'none' || style.visibility === 'hidden') {
            return;
        }
        
        // 跳过 checkbox/radio 类型的同意条款
        if (input.type === 'checkbox' || input.type === 'radio') {
            let labelText = '';
            // ... 获取标签文本的逻辑 ...
            const isAgreementField = excludeKeywords.some(keyword => labelText.includes(keyword));
            if (isAgreementField) {
                console.log(`⏭️  跳过同意条款字段: "${labelText.substring(0, 30)}..."`);
                return;
            }
        }
        
        // 跳过只读和禁用的输入框
        if (input.readOnly || input.disabled) return;
        
        // 跳过 type=submit/button/hidden 的输入框
        const skipTypes = ['submit', 'button', 'hidden', 'image', 'reset'];
        if (skipTypes.includes(input.type)) return;
        
        inputs.push(input);
    });
    
    console.log(`📋 共找到 ${inputs.length} 个有效输入框（已过滤同意条款和按钮）`);
    return inputs;
}
```

### 2. 优化 `waitForInputs()` 函数

**位置**：`gui/new_fill_window.py` - `generate_wjx_fill_script()` 方法内

**改进内容**：
- ✅ 等待**有效**输入框加载，而不是所有 input 元素
- ✅ 使用与 `getAllInputs()` 相同的过滤规则，确保一致性
- ✅ 增加最大尝试次数（15 → 20）和等待间隔（400ms → 500ms）
- ✅ 详细的日志输出，显示总输入框数和有效输入框数

**关键代码**：
```javascript
function waitForInputs(maxAttempts = 20, interval = 500) {
    return new Promise((resolve) => {
        let attempts = 0;
        const checkInputs = setInterval(() => {
            attempts++;
            
            // 统计所有输入框
            const allInputs = document.querySelectorAll('input, textarea');
            
            // 统计有效输入框（使用与 getAllInputs 相同的过滤规则）
            let validInputCount = 0;
            // ... 过滤逻辑 ...
            
            console.log(`🔍 尝试 ${attempts}/${maxAttempts}: 找到 ${allInputs.length} 个输入框，其中 ${validInputCount} 个有效`);
            
            if (validInputCount > 0 || attempts >= maxAttempts) {
                clearInterval(checkInputs);
                if (validInputCount > 0) {
                    console.log(`✅ 成功找到 ${validInputCount} 个有效输入框`);
                    resolve(true);
                } else {
                    console.warn(`⚠️ 未找到有效输入框`);
                    resolve(false);
                }
            }
        }, interval);
    });
}
```

## 预期效果

修复后，问卷星表单填充应该能够：
1. ✅ 正确过滤掉"同意条款"等无关字段
2. ✅ 识别出所有有效的表单输入字段
3. ✅ 成功匹配和填充用户数据
4. ✅ 提供清晰的日志输出，便于调试

## 测试建议

1. 访问问卷星表单：`https://v.wjx.cn/vm/PcfX2M5.aspx`
2. 使用名片"111"进行填充
3. 检查日志输出：
   - 应该看到"✅ 成功找到 X 个有效输入框"（X > 0）
   - 应该看到"⏭️ 跳过同意条款字段"的日志
   - 应该看到成功匹配和填充的字段列表

## 相关文件

- `/Users/chenchen/Desktop/开发项目/auto-form-filler-py/gui/new_fill_window.py`
  - `generate_wjx_fill_script()` 方法（第 4549 行开始）

## 修复日期

2025-12-30

