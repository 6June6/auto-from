name: Build Apps

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: # 手动触发

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "PyQt6==6.6.1" "PyQt6-Qt6==6.6.1" "PyQt6-WebEngine==6.6.0" "PyQt6-WebEngine-Qt6==6.6.0" --force-reinstall
          pip install pyinstaller

      - name: Build Windows App
        shell: cmd
        run: |
          pyinstaller --name="自动表单填写工具-Windows" --windowed --onedir --clean --noupx --collect-all PyQt6 --collect-all PyQt6.QtCore --collect-all PyQt6.QtWidgets --collect-all PyQt6.QtGui --collect-all PyQt6.QtWebEngineWidgets --collect-all PyQt6.QtWebEngineCore --hidden-import=PyQt6.sip --hidden-import=PyQt6.QtCore --hidden-import=PyQt6.QtWidgets --hidden-import=PyQt6.QtGui --hidden-import=PyQt6.QtNetwork --hidden-import=PyQt6.QtWebChannel main.py

      - name: Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: Windows-App
          path: dist/自动表单填写工具-Windows/

  build-macos-intel:
    runs-on: macos-13 # Intel Mac
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "PyQt6-Qt6==6.6.1" "PyQt6-WebEngine-Qt6==6.6.0" --force-reinstall
          pip install pyinstaller

      - name: Build macOS Intel App
        run: |
          pyinstaller --name="自动表单填写工具-Intel" --windowed --onedir --clean --osx-bundle-identifier=com.autofill.app main.py

      - name: Upload macOS Intel Build
        uses: actions/upload-artifact@v4
        with:
          name: macOS-Intel-App
          path: dist/自动表单填写工具-Intel.app/

  build-macos-arm:
    runs-on: macos-14 # Apple Silicon Mac
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build macOS ARM App
        run: |
          pyinstaller --name="自动表单填写工具-AppleSilicon" --windowed --onedir --clean --osx-bundle-identifier=com.autofill.app main.py

      - name: Upload macOS ARM Build
        uses: actions/upload-artifact@v4
        with:
          name: macOS-AppleSilicon-App
          path: dist/自动表单填写工具-AppleSilicon.app/
